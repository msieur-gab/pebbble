<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Pebbble Player - iOS Compatible Mode">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.svg">

    <!-- Styles -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">

    <title>Pebbble Player (iOS)</title>
    <style>
        /* iOS Mode Indicator */
        .ios-badge {
            position: fixed;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #007AFF;
            color: #fff;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            z-index: 1000;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Missing Params Screen */
        #missing-params {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            text-align: center;
            background: #1a1a1a;
            color: #fff;
        }
        #missing-params.visible { display: flex; }
        #missing-params h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        #missing-params .subtitle {
            color: #888;
            margin-bottom: 2rem;
        }
        #missing-params .info-box {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 320px;
            text-align: left;
        }
        #missing-params .info-box h3 {
            font-size: 0.85rem;
            color: #FF4D00;
            margin-bottom: 0.75rem;
        }
        #missing-params .info-box p {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        #missing-params .info-box code {
            display: block;
            background: #111;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.7rem;
            color: #0f0;
            word-break: break-all;
            margin-top: 0.5rem;
        }
        #missing-params .status-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
        }
        #missing-params .status-row:last-child { border-bottom: none; }
        #missing-params .status-label { color: #888; }
        #missing-params .status-value { font-family: monospace; }
        #missing-params .status-value.ok { color: #22c55e; }
        #missing-params .status-value.missing { color: #ff4444; }
    </style>
</head>
<body>
    <!-- iOS Mode Badge -->
    <div class="ios-badge">iOS Mode</div>

    <!-- Missing Params Screen (shown when URL doesn't have both serial and playlistHash) -->
    <div id="missing-params">
        <h1>ðŸª¨ Pebbble iOS Mode</h1>
        <p class="subtitle">Serial-in-URL for Safari & Brave</p>

        <div class="info-box">
            <h3>URL Parameters</h3>
            <div class="status-row">
                <span class="status-label">serial</span>
                <span id="serial-status" class="status-value missing">Missing</span>
            </div>
            <div class="status-row">
                <span class="status-label">playlistHash</span>
                <span id="hash-status" class="status-value missing">Missing</span>
            </div>
        </div>

        <div class="info-box" style="margin-top: 1rem;">
            <h3>How It Works</h3>
            <p>
                Since Safari/Brave don't support Web NFC, the tag serial must be embedded in the URL.
                When you tap a Pebbble configured for iOS, it opens a URL containing both the serial and playlist hash.
            </p>
            <p><strong>Expected URL format:</strong></p>
            <code>ios.html#serial=04:XX:XX:XX:XX:XX:XX&playlistHash=QmXxx...</code>
        </div>

        <div class="info-box" style="margin-top: 1rem;">
            <h3>Manual Test</h3>
            <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.7rem; color: #888; margin-bottom: 0.25rem;">Serial</label>
                <input type="text" id="test-serial" placeholder="04:XX:XX:XX:XX:XX:XX" style="
                    width: 100%;
                    padding: 0.5rem;
                    background: #111;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: #fff;
                    font-family: monospace;
                    font-size: 0.85rem;
                    box-sizing: border-box;
                ">
            </div>
            <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.7rem; color: #888; margin-bottom: 0.25rem;">Playlist Hash</label>
                <input type="text" id="test-hash" placeholder="QmXxx..." style="
                    width: 100%;
                    padding: 0.5rem;
                    background: #111;
                    border: 1px solid #444;
                    border-radius: 6px;
                    color: #fff;
                    font-family: monospace;
                    font-size: 0.85rem;
                    box-sizing: border-box;
                ">
            </div>
            <button id="test-load-btn" style="
                width: 100%;
                padding: 0.75rem;
                background: #FF4D00;
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
            ">Load Playlist</button>
        </div>
    </div>

    <!-- App Section -->
    <main id="app">
        <pebbble-player></pebbble-player>
    </main>

    <!-- Audio element for playback -->
    <audio id="audio-element" preload="metadata" playsinline></audio>

    <!-- Toast notifications -->
    <toast-notification></toast-notification>

    <!-- iOS URL Handler -->
    <script>
        (function() {
            var app = document.getElementById('app');
            var missingScreen = document.getElementById('missing-params');
            var serialStatus = document.getElementById('serial-status');
            var hashStatus = document.getElementById('hash-status');

            // Parse URL hash params
            var hash = window.location.hash.slice(1);
            var params = new URLSearchParams(hash);
            var serial = params.get('serial');
            var playlistHash = params.get('playlistHash');

            console.log('[iOS] Serial:', serial);
            console.log('[iOS] PlaylistHash:', playlistHash);

            // Update status display
            if (serial) {
                serialStatus.textContent = serial.slice(0, 11) + '...';
                serialStatus.className = 'status-value ok';
            }
            if (playlistHash) {
                hashStatus.textContent = playlistHash.slice(0, 8) + '...';
                hashStatus.className = 'status-value ok';
            }

            if (serial && playlistHash) {
                // Both params present - show app, hide missing screen
                app.style.display = 'block';
                missingScreen.classList.remove('visible');
                console.log('[iOS] URL params valid, PebbblePlayer.checkUrlParams() will handle loading');
                // Note: We don't need to dispatch an event here.
                // PebbblePlayer.checkUrlParams() already detects serial+playlistHash in the URL
                // and calls handleNfcRead() directly (debug mode).
            } else {
                // Missing params - show info screen, hide app
                app.style.display = 'none';
                missingScreen.classList.add('visible');
                console.log('[iOS] Missing URL params, showing info screen');

                // Setup manual test button
                document.getElementById('test-load-btn').addEventListener('click', function() {
                    var testSerial = document.getElementById('test-serial').value.trim();
                    var testHash = document.getElementById('test-hash').value.trim();

                    if (testSerial && testHash) {
                        // Redirect to same page with URL params
                        window.location.href = 'ios.html#serial=' + encodeURIComponent(testSerial) + '&playlistHash=' + encodeURIComponent(testHash);
                    } else {
                        alert('Please enter both Serial and Playlist Hash');
                    }
                });
            }
        })();
    </script>

    <!-- App modules -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
