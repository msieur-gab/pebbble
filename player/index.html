<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Pebbble Player - Listen to encrypted voice messages from your magic stone">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.svg">

    <!-- Styles -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">

    <title>Pebbble Player</title>
</head>
<body>
    <!-- Debug Panel (sliding from bottom) -->
    <div id="debug-panel" style="position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#111;color:#0f0;font-family:monospace;font-size:11px;padding:8px;transform:translateY(100%);transition:transform 0.3s;z-index:9999;border-top:2px solid #0f0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="color:#0f0;font-weight:bold;">>> DEBUG LOG <<</span>
            <button onclick="this.parentElement.parentElement.style.transform='translateY(100%)'" style="background:#333;color:#fff;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;">Close</button>
        </div>
        <div id="debug-log"></div>
    </div>
    <button id="show-debug" onclick="document.getElementById('debug-panel').style.transform='translateY(0)'" style="position:fixed;bottom:10px;right:10px;background:#222;color:#0f0;border:1px solid #0f0;padding:6px 10px;border-radius:4px;z-index:9998;font-size:11px;cursor:pointer;">Debug</button>

    <!-- NFC Button (OUTSIDE Shadow DOM - required for user activation) -->
    <button id="global-nfc-btn" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#FF4D00;color:#fff;border:none;padding:16px 32px;border-radius:50px;font-size:18px;font-weight:600;z-index:1000;box-shadow:0 4px 20px rgba(255,77,0,0.4);cursor:pointer;">
        ðŸ“¡ Activate NFC
    </button>

    <main id="app">
        <!-- App components will be mounted here -->
        <pebbble-player></pebbble-player>
    </main>

    <!-- Audio element for playback -->
    <audio id="audio-element" preload="metadata" playsinline></audio>

    <!-- NFC Handler Script (MUST be inline, outside modules, for user activation) -->
    <script>
        // Debug logger
        window.debugLog = function(msg) {
            var log = document.getElementById('debug-log');
            var time = new Date().toLocaleTimeString();
            var div = document.createElement('div');
            div.textContent = time + ': ' + msg;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            console.log('[NFC Debug]', msg);
        };

        // Show the global NFC button
        window.showGlobalNfcBtn = function() {
            document.getElementById('global-nfc-btn').style.display = 'block';
        };

        // Hide the global NFC button
        window.hideGlobalNfcBtn = function() {
            document.getElementById('global-nfc-btn').style.display = 'none';
        };

        // NFC button handler - DIRECT click, no Shadow DOM, no event bus
        document.getElementById('global-nfc-btn').addEventListener('click', async function() {
            var btn = this;
            debugLog('Button clicked');
            btn.textContent = 'Starting...';
            btn.disabled = true;

            try {
                if (!('NDEFReader' in window)) {
                    debugLog('NDEFReader not in window - NFC not supported');
                    btn.textContent = 'NFC Not Supported';
                    return;
                }

                debugLog('Creating NDEFReader...');
                var reader = new NDEFReader();

                debugLog('Setting onreading handler...');
                reader.onreading = function(event) {
                    debugLog('TAG READ! Serial: ' + event.serialNumber);

                    var url = null;
                    if (event.message && event.message.records) {
                        for (var i = 0; i < event.message.records.length; i++) {
                            var record = event.message.records[i];
                            if (record.recordType === 'url') {
                                var decoder = new TextDecoder();
                                url = decoder.decode(record.data);
                                debugLog('URL from tag: ' + url);
                                break;
                            }
                        }
                    }

                    // Dispatch event for app.js to handle
                    window.dispatchEvent(new CustomEvent('nfc-tag-scanned', {
                        detail: {
                            serial: event.serialNumber,
                            url: url,
                            message: event.message
                        }
                    }));
                };

                reader.onreadingerror = function(e) {
                    debugLog('Reading error: ' + (e.message || 'unknown'));
                };

                debugLog('Calling reader.scan()...');
                await reader.scan();
                debugLog('scan() returned - NFC is now active!');

                btn.textContent = 'ðŸ“¡ Scanning... Tap Pebbble';
                btn.style.background = '#22c55e';

            } catch (e) {
                debugLog('ERROR: ' + e.name + ' - ' + e.message);
                btn.textContent = 'Error - Try Again';
                btn.style.background = '#ef4444';
                btn.disabled = false;
            }
        });

        debugLog('NFC handler script loaded');
    </script>

    <!-- App modules -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
